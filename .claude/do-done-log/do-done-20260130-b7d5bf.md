# Session: 20260130-b7d5bf

---
*2026-01-29 20:49*

## Eli:
Implement the following plan:

# Plan: Make Mouse Drag Eventtap Rock-Solid

## Problem
The eventtap for "Cmd+Option+Ctrl + mouse move to drag window" stops working silently after a while, even though `isEnabled()` still returns true (a "zombie" state).

## Root Causes Identified
1. **Garbage Collection**: Local variables storing eventtaps can be garbage collected
2. **Zombie Detection Failure**: `isEnabled()` returns true even when eventtap stops receiving events
3. **No Activity Tracking**: Current watchdog can't detect silent failures

## Solution

### 1. Use Global Variables
Change from `local` to global storage to prevent garbage collection:
```lua
-- Before (gets GC'd)
local mouseMoveHandler, flagsHandler

-- After (persists)
_G.windowDrag = {
    mouseMoveHandler = nil,
    flagsHandler = nil,
    ...
}
```

### 2. Add Callback Counting for Zombie Detection
Track the last time a callback fired:
```lua
_G.windowDrag.lastCallbackTime = 0

-- In callback:
_G.windowDrag.lastCallbackTime = hs.timer.secondsSinceEpoch()
```

### 3. Enhanced Watchdog
Check both `isEnabled()` AND whether callbacks are still firing:
```lua
hs.timer.new(3, function()
    local timeSinceCallback = hs.timer.secondsSinceEpoch() - _G.windowDrag.lastCallbackTime
    local enabled = handler:isEnabled()

    -- Restart if disabled OR if no callbacks for 10+ seconds while mouse is visible
    if not enabled or (timeSinceCallback > 10 and hs.mouse.isVisible()) then
        restartEventTaps()
    end
end)
```

### 4. Use Delta Properties (Optional Enhancement)
Use event deltas for smoother dragging:
```lua
local dx = event:getProperty(hs.eventtap.event.properties.mouseEventDeltaX)
local dy = event:getProperty(hs.eventtap.event.properties.mouseEventDeltaY)
```

## Files to Modify
- `/Users/sara/Library/CloudStorage/Dropbox/projects/log/2025/hammerspoon/move-resize.lua` (lines 200-313)

## Implementation Changes

Replace the current mouse drag section (lines 200-313) with:
1. Global `_G.windowDrag` 

[...truncated...]

## Claude:
The implementation is complete. Here's a summary of the changes made:

**Key improvements:**

1. **Global storage** - All state is now stored in `_G.windowDrag` table to prevent Lua garbage collection from destroying the eventtaps

2. **Callback timestamp tracking** - Each callback updates `_G.windowDrag.lastCallbackTime` so we can detect when eventtaps stop firing

3. **Enhanced watchdog** - Runs every 3 seconds and checks:
   - If handler is missing or disabled → restart
   - If no callbacks for 10+ seconds while mouse is active → zombie detected, restart

4. **Smoother dragging** - Uses `event:getProperty(mouseEventDeltaX/Y)` for delta-based movement instead of calculating from absolute positions

5. **Reload-safe** - Properly stops existing handlers and watchdog when reloading config

**To verify:**
1. Reload Hammerspoon config (the console should show "Window drag with Cmd+Option+Ctrl enabled (with enhanced zombie detection)")
2. Test Cmd+Option+Ctrl + mouse drag on any window
3. Wait 5+ minutes and verify it still works
4. Watch the console for "Zombie eventtap detected" messages if the watchdog triggers


---
*2026-01-29 20:58*

## Eli:
this is now working well after 5 minutes! I'm super excited! should we toggle off all print elements for now?

## Claude:
Done - all print statements removed from the mouse drag section. The watchdog will now silently restart the eventtaps when needed.


---
*2026-01-29 21:00*

## Eli:
yay, let's commit thsi gorgeousness!

## Claude:
Committed as `9398eff`. The mouse drag fix is now safely stored.

